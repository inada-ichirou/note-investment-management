# AIè¨˜äº‹ç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹
class AiArticleService
  API_URL = 'https://openrouter.ai/api/v1/chat/completions'
  MODEL = 'deepseek/deepseek-chat-v3-0324:free'
  
  # é¡Œæãƒªã‚¹ãƒˆï¼ˆJavaScriptã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç§»æ¤ï¼‰
  TOPICS = [
    'è³‡ç”£é‹ç”¨ã®åŸºç¤',
    'æŠ•è³‡åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰',
    'æŠ•è³‡ä¿¡è¨—',
    'æŠ•è³‡ä¿¡è¨—ã®ãƒ¡ãƒªãƒƒãƒˆ',
    'æ ªå¼æŠ•è³‡ã®å§‹ã‚æ–¹',
    'FIREï¼ˆçµŒæ¸ˆçš„è‡ªç«‹ãƒ»æ—©æœŸé€€è·ï¼‰',
    'FIREé”æˆã®ãŸã‚ã®æˆ¦ç•¥',
    'è³‡ç”£å½¢æˆã®åŸºæœ¬',
    'æŠ•è³‡åˆå¿ƒè€…ã®æ‚©ã¿',
    'é•·æœŸæŠ•è³‡ã®ãƒ¡ãƒªãƒƒãƒˆ',
    'æŠ•è³‡å®¶ã®ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆ',
    'è³‡ç”£é‹ç”¨ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—',
    'åŠ¹ç‡çš„ãªæŠ•è³‡ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª',
    'æŠ•è³‡ã§å¤±æ•—ã—ãªã„ãŸã‚ã®å¿ƒæ§‹ãˆ',
    'åˆå¿ƒè€…ã‹ã‚‰ã®è³‡ç”£å½¢æˆ',
    'æˆåŠŸæŠ•è³‡å®¶ã®1æ—¥ãƒ»æŠ•è³‡ã‚¹ã‚¿ã‚¤ãƒ«',
    'è‡ªèº«ã®æŠ•è³‡ã«ãŠã‘ã‚‹æˆåŠŸè«‡ãƒ»å¤±æ•—è«‡'
  ].freeze

  # åˆ‡ã‚Šå£ãƒªã‚¹ãƒˆï¼ˆJavaScriptã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç§»æ¤ï¼‰
  PATTERNS = [
    'ä¸€æ­©è¸ã¿è¾¼ã‚“ã ç†è§£',
    'å…·ä½“çš„ãªæ´»ç”¨æ–¹æ³•',
    'æ¥½ã«ã™ã‚‹æ–¹æ³•',
    'æŠ•è³‡ã™ã‚‹ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆ',
    'è¤‡åˆ©åŠ¹æœã®å¨åŠ›',
    'ãƒ©ãƒ³ã‚­ãƒ³ã‚°-ãƒˆãƒƒãƒ—5',
    'ãƒ©ãƒ³ã‚­ãƒ³ã‚°-ãƒˆãƒƒãƒ—5',
    'ãƒ©ãƒ³ã‚­ãƒ³ã‚°-ãƒˆãƒƒãƒ—5',
    'ãƒ©ãƒ³ã‚­ãƒ³ã‚°-ãƒˆãƒƒãƒ—5',
    'ã¾ã¤ã‚ã‚‹Q&Aã¾ã¨ã‚',
    'ã‚„ã£ã¦ã¯ã„ã‘ãªã„NGè¡Œå‹•',
    'åˆå¿ƒè€…ãŒæœ€åˆã®1ãƒ¶æœˆã§ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ',
    'ãƒ—ãƒ­ã«èã„ãŸæ¥µæ„'
  ].freeze

  def self.generate_article
    # ãƒ©ãƒ³ãƒ€ãƒ ã«é¡Œæã¨åˆ‡ã‚Šå£ã‚’é¸æŠ
    topic = TOPICS.sample
    pattern = PATTERNS.sample
    
    Rails.logger.info "é¸ã°ã‚ŒãŸé¡Œæ: #{topic}"
    Rails.logger.info "é¸ã°ã‚ŒãŸåˆ‡ã‚Šå£: #{pattern}"
    
    # AIè¨˜äº‹ç”Ÿæˆ
    article = generate_content(topic, pattern)
    
    if article.blank? || article.length < 30
      raise StandardError, 'AIè¨˜äº‹ç”Ÿæˆã«å¤±æ•—ã€ã¾ãŸã¯å†…å®¹ãŒä¸ååˆ†ã§ã™'
    end
    
    # ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡ºã¨H1é™¤å»
    title, filtered_article = extract_title_and_filter_h1(article)
    
    # è¨˜äº‹ãƒªãƒ©ã‚¤ãƒˆãƒ»ã‚¿ã‚°ä»˜ä¸
    rewritten_article = rewrite_and_tag_article(filtered_article)
    
    {
      title: title,
      content: rewritten_article,
      topic: topic,
      pattern: pattern
    }
  end

  private

  def self.generate_content(topic, pattern)
    prompt_lines = [
      'ã‚ãªãŸã¯æ—¥æœ¬èªã®noteè¨˜äº‹ç·¨é›†è€…ã§ã™ã€‚ä»¥ä¸‹ã®é¡Œæã¨åˆ‡ã‚Šå£ã§noteè¨˜äº‹ã‚’1æœ¬ä½œæˆã—ã¦ãã ã•ã„ã€‚',
      '',
      "é¡Œæ: #{topic}",
      "åˆ‡ã‚Šå£: #{pattern}",
      '',
      'ã€æ¡ä»¶ã€‘',
      '- ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆ#ã‹ã‚‰å§‹ã¾ã‚‹ã‚‚ã®ï¼‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚',
      '- ã‚¿ã‚¤ãƒˆãƒ«ã¯1è¡Œç›®ã«ã€Œ# ã‚¿ã‚¤ãƒˆãƒ«ã€ã¨ã—ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
      '- æœ¬æ–‡ã¯è¦‹å‡ºã—ã‚„ç®‡æ¡æ›¸ãã‚‚äº¤ãˆã¦1000æ–‡å­—ç¨‹åº¦ã§ä¸å¯§ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚',
      '- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯è¨˜äº‹æœ«å°¾ã«ã€Œ#ã€‡ã€‡ #ã€‡ã€‡ ...ã€ã®å½¢å¼ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚',
      '- ã™ã¹ã¦æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚',
      '- åˆ‡ã‚Šå£ã«æ²¿ã£ãŸå†…å®¹ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚',
      '- ã‚ãªãŸã¯ãƒ—ãƒ­ã®æŠ•è³‡å®¶ã§ã€ãƒ—ãƒ­ã®ç·¨é›†è€…ã§ã™ã€‚',
      '- èª­ã¿ã‚„ã™ã•ã‚’é‡è¦–ã—ã¦ãã ã•ã„',
      '- ã‚‚ã—é¡Œæãƒ»åˆ‡ã‚Šå£ã‚’é‘‘ã¿ã¦å¯èƒ½ã§ã‚ã‚Œã°ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ã«ã—ã¦ãã ã•ã„',
      '- æ”¹è¡Œã‚’å¤šã‚ã«å…¥ã‚Œã¦ã€èª­ã¿ã‚„ã™ãã—ã¦ãã ã•ã„ã€‚',
      '- æ–‡ç« ä½œæˆæ™‚ã«å¤šã‚ã«ã€ãŸãã•ã‚“çµµæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å„è¡Œã«1ã¤ãã‚‰ã„ã¯å…¥ã‚Œã¦ãã ã•ã„ã€‚',
      '- ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã äººãŒæŠ•è³‡ã—ãŸã„ã€ã¨ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã‚ˆã†ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚',
      '- æŠ•è³‡åˆå¿ƒè€…ãŒã¤ã„èª­ã¿ãŸããªã‚‹ã‚ˆã†ãªã€ã‚„ã•ã—ãè¦ªã—ã¿ã‚„ã™ã„å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚',
      '- ç¾å½¹ã®æŠ•è³‡å®¶å‘ã‘ã®é›£ã—ã„å†…å®¹ã‚„å°‚é–€çš„ã™ãã‚‹è©±é¡Œã¯é¿ã‘ã¦ãã ã•ã„ã€‚',
      '- noteã®æ­£ã—ã„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã®ã¿ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚',
      '- ç®‡æ¡æ›¸ãã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§ã¯ãªãã€ã€Œãƒ» ã€ã§è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚',
      '- è¦‹å‡ºã—ã¯h2ï¼ˆ## è¦‹å‡ºã—ï¼‰ãƒ»h3ï¼ˆ### è¦‹å‡ºã—ï¼‰ã®ã¿ã€‚',
      '- ç•ªå·ä»˜ããƒªã‚¹ãƒˆã¯ä½¿ã‚ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚',
      '- h1ï¼ˆ# ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¯ã‚¿ã‚¤ãƒˆãƒ«è¡Œã®ã¿ã§æœ¬æ–‡ä¸­ã§ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚',
      '- ãã®ä»–ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚„HTMLã‚¿ã‚°ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚'
    ]
    
    prompt = prompt_lines.join("\n")
    messages = [
      { role: 'system', content: 'ã‚ãªãŸã¯æ—¥æœ¬èªã®noteè¨˜äº‹ç·¨é›†è€…ã§ã™ã€‚' },
      { role: 'user', content: prompt }
    ]

    # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
    3.times do |attempt|
      begin
        response = Faraday.post(API_URL) do |req|
          req.headers['Authorization'] = "Bearer #{ENV['OPENROUTER_API_KEY']}"
          req.headers['Content-Type'] = 'application/json'
          req.body = {
            model: MODEL,
            messages: messages,
            max_tokens: 1200,
            temperature: 0.7
          }.to_json
        end

        data = JSON.parse(response.body)
        
        unless response.success?
          Rails.logger.error "OpenRouter API Error: #{data}"
          raise StandardError, "API error: #{response.status}"
        end
        
        content = data.dig('choices', 0, 'message', 'content')
        if content.present?
          Rails.logger.info "AIè¨˜äº‹ç”Ÿæˆå®Œäº† (è©¦è¡Œå›æ•°: #{attempt + 1})"
          return content
        end
        
      rescue StandardError => e
        Rails.logger.error "AIè¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ#{attempt + 1}): #{e.message}"
        raise e if attempt == 2 # æœ€å¾Œã®è©¦è¡Œã§ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ä¾‹å¤–ã‚’æŠ•ã’ã‚‹
        sleep 1 # 1ç§’å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
      end
    end
    
    raise StandardError, 'AIè¨˜äº‹ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
  end

  def self.extract_title_and_filter_h1(article)
    title = 'ç„¡é¡Œ'
    title_match = article.match(/^#\s*(.+)$/m)
    
    if title_match && title_match[1].strip.present?
      title = title_match[1].strip
    else
      # å…ˆé ­è¡ŒãŒã‚¿ã‚¤ãƒˆãƒ«ã§ãªã„å ´åˆã€æœ€åˆã®10æ–‡å­—ã‚’ä»®ã‚¿ã‚¤ãƒˆãƒ«ã«
      first_line = article.split("\n").find { |line| line.strip.present? }
      title = first_line&.slice(0, 10) || 'ç„¡é¡Œ'
    end

    h1_title_line = "# #{title}"
    filtered_lines = article.split("\n").reject { |line| line.strip == h1_title_line }
    filtered_article = filtered_lines.join("\n")

    Rails.logger.info "æŠ½å‡ºã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«: #{title}"
    
    [title, filtered_article]
  end

  def self.rewrite_and_tag_article(content)
    # ç°¡æ˜“ç‰ˆã®å®Ÿè£…ï¼ˆå®Œå…¨ç‰ˆã¯å¿…è¦ã«å¿œã˜ã¦å¾Œã§å®Ÿè£…ï¼‰
    # è¨˜äº‹æœ«å°¾ã«ãƒ•ã‚©ãƒ­ãƒ¼æ¡ˆå†…ã¨ã‚¿ã‚°ã‚’è¿½åŠ 
    info_text = [
      'æœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ’¬',
      'ç¶™ç¶šã—ã¦ã€ãŠå¾—ãªæƒ…å ±ã‚’ç™ºä¿¡ã—ã¦ã„ãã¾ã™ã®ã§ã€ãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„ã—ã¾ã™ï¼'
    ].join("\n")
    
    # ç°¡æ˜“çš„ãªã‚¿ã‚°ç”Ÿæˆ
    tags = '#æŠ•è³‡ #è³‡ç”£é‹ç”¨ #åˆå¿ƒè€… #FIRE #æŠ•è³‡ä¿¡è¨—'
    
    "#{content.strip}\n\n#{info_text}\n\n#{tags}\n"
  end
end
